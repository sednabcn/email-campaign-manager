name: Cleanup Old Workflow Runs
on:
  push:
    branches: ["dev", "master"]


  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      actions: write
      contents: read
    steps:
      - name: Delete All Old and Failed Workflow Runs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const KEEP_RECENT_RUNS = 3;
            const KEEP_DAYS = 2;
            const MAX_PAGES = 100;
            const DELETE_OLD_EVEN_IF_SUCCESSFUL = true;

            console.log(`üßπ Cleaning workflow runs for ${owner}/${repo}`);

            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - KEEP_DAYS);

            const { data: workflowsData } = await github.rest.actions.listRepoWorkflows({ owner, repo });
            const workflows = workflowsData.workflows || [];

            for (const workflow of workflows) {
              console.log(`Processing workflow: ${workflow.name}`);
              let allRuns = [];
              for (let page = 1; page <= MAX_PAGES; page++) {
                const { data } = await github.rest.actions.listWorkflowRuns({
                  owner,
                  repo,
                  workflow_id: workflow.id,
                  status: 'completed',  // ‚úÖ only deletable
                  per_page: 100,
                  page
                });
                if (!data.workflow_runs.length) break;
                allRuns = allRuns.concat(data.workflow_runs);
              }

              // Sort newest ‚Üí oldest
              allRuns.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

              const runsToDelete = [];
              const runsToKeep = allRuns.slice(0, KEEP_RECENT_RUNS);

              for (const run of allRuns.slice(KEEP_RECENT_RUNS)) {
                const runDate = new Date(run.created_at);
                const isOld = runDate < cutoffDate;
                const isFailed = run.conclusion !== 'success';
                if (isFailed || (DELETE_OLD_EVEN_IF_SUCCESSFUL && isOld)) {
                  runsToDelete.push(run);
                }
              }

              console.log(`üóëÔ∏è ${runsToDelete.length} runs to delete from ${workflow.name}`);

              for (const run of runsToDelete) {
                try {
                  await github.rest.actions.deleteWorkflowRun({ owner, repo, run_id: run.id });
                  console.log(`Deleted run ${run.id} (${run.name})`);
                  await new Promise(r => setTimeout(r, 300));
                } catch (err) {
                  console.log(`‚ùå Could not delete run ${run.id}: ${err.message}`);
                }
              }
            }

            console.log("‚úÖ Cleanup finished");
